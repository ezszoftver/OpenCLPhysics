#pragma OPENCL EXTENSION cl_khr_global_int32_base_atomics : enable

#define LOCK(a) atom_cmpxchg(a, 0, 1)
#define UNLOCK(a) atom_xchg(a, 0)

__kernel void mutex_test(__global int *count, __global int *mutex) {

   if(get_local_id(0) == 0) {
   
      /* Increment the count */
      while(LOCK(mutex));
      *count += 1;
      UNLOCK(mutex);

      /* Wait for everyone else to increment the count */
      int waiting = 1;
      while(waiting) {
         while(LOCK(mutex));
         if(*count == get_num_groups(0)) {
            waiting = 0;
         }
         UNLOCK(mutex);
      }
   }
}